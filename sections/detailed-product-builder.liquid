{%- comment -%}
  Detailed Product Builder Section
  Provides a flexible page builder plus a custom editorial feature block.
{%- endcomment -%}

<section class="section section--detailed-product-builder">
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 class="h2">{{ section.settings.heading | escape }}</h2>
    {% endif %}

    {% if section.settings.content != blank %}
      <div class="rte">{{ section.settings.content }}</div>
    {% endif %}

    {% for block in section.blocks %}
      {% case block.type %}
        {% when 'text' %}
          <p {{ block.shopify_attributes }}>{{ block.settings.text }}</p>

        {% when 'subheading' %}
          <h3 class="h3" {{ block.shopify_attributes }}>{{ block.settings.subheading }}</h3>

        {% when 'spacer' %}
          <div style="height: {{ block.settings.height }}px" aria-hidden="true" {{ block.shopify_attributes }}></div>

        {% when 'richtext' %}
          <div class="rte" {{ block.shopify_attributes }}>{{ block.settings.richtext }}</div>

        {% when 'image' %}
          {% if block.settings.image != blank %}
            <figure class="builder-image" style="text-align: {{ block.settings.alignment }}; max-width: {{ block.settings.max_width }}px;" {{ block.shopify_attributes }}>
              <img
                src="{{ block.settings.image | image_url: width: block.settings.max_width }}"
                alt="{{ block.settings.alt | escape }}"
                loading="lazy"
                width="{{ block.settings.image.width }}"
                height="{{ block.settings.image.height }}"
                style="width:100%;height:auto;"
              >
              {% if block.settings.caption != blank %}
                <figcaption class="builder-image__caption">{{ block.settings.caption }}</figcaption>
              {% endif %}
            </figure>
          {% endif %}

        {% when 'button' %}
          {% if block.settings.link != blank and block.settings.label != blank %}
            <div class="builder-button" style="text-align: {{ block.settings.alignment }};" {{ block.shopify_attributes }}>
              <a href="{{ block.settings.link }}" class="button button--primary">{{ block.settings.label }}</a>
            </div>
          {% endif %}

        {% when 'divider' %}
          <hr class="builder-divider" {{ block.shopify_attributes }}>

        {% when 'liquid' %}
          <div {{ block.shopify_attributes }}>{{ block.settings.custom_liquid }}</div>

        {% when 'product' %}
          {% if block.settings.product != blank %}
            <div class="builder-product" {{ block.shopify_attributes }}>
              {% render 'card-product', card_product: block.settings.product %}
            </div>
          {% endif %}

        {% when 'collection' %}
          {% if block.settings.collection != blank %}
            <div class="builder-collection" {{ block.shopify_attributes }}>
              <div class="grid" style="--grid-cols: {{ block.settings.columns }};">
                {% for product in block.settings.collection.products limit: block.settings.limit %}
                  <div class="grid__item">
                    {% render 'card-product', card_product: product %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endif %}

        {% when 'video' %}
          {% if block.settings.video_url != blank %}
            <div class="builder-video" style="text-align: {{ block.settings.alignment }};" {{ block.shopify_attributes }}>
              <div class="video-wrapper">
                {% if block.settings.video_url contains 'youtube' %}
                  <iframe src="https://www.youtube.com/embed/{{ block.settings.video_url | split: 'v=' | last | split: '&' | first }}" title="YouTube video" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {% elsif block.settings.video_url contains 'vimeo' %}
                  <iframe src="https://player.vimeo.com/video/{{ block.settings.video_url | split: '/' | last }}" title="Vimeo video" frameborder="0" allowfullscreen loading="lazy"></iframe>
                {% endif %}
              </div>
            </div>
          {% endif %}

        {% when 'editorial_product_feature' %}
          {% assign feature = block.settings.metaobject %}
          <div class="editorial-feature" {{ block.shopify_attributes }}
            style="--title-col: {{ block.settings.heading_colour }}; --band-col: {{ block.settings.band_colour }};">
            <div class="editorial-feature__stage">
              <div class="editorial-feature__band" aria-hidden="true"></div>

              {%- assign hero_image = feature.hero_image | default: feature.image | default: feature.featured_image -%}
              {%- assign small_image = feature.secondary_image | default: feature.supporting_image -%}
              {%- assign tertiary_image = feature.tertiary_image | default: feature.bottom_image -%}

              {% if hero_image != blank %}
                <figure class="polaroid polaroid--hero">
                  <div class="polaroid__frame">
                    <img src="{{ hero_image | image_url: width: 800 }}" alt="{{ hero_image.alt | default: block.settings.hero_caption_override | escape }}" loading="lazy" width="{{ hero_image.width }}" height="{{ hero_image.height }}">
                  </div>
                  {% assign hero_caption = block.settings.hero_caption_override | default: feature.hero_caption | default: feature.caption %}
                  {% if hero_caption != blank %}
                    <figcaption class="polaroid__caption">{{ hero_caption }}</figcaption>
                  {% endif %}
                </figure>
              {% endif %}

              {% if small_image != blank %}
                <figure class="polaroid polaroid--small">
                  <div class="polaroid__frame">
                    <img src="{{ small_image | image_url: width: 600 }}" alt="{{ small_image.alt | escape }}" loading="lazy" width="{{ small_image.width }}" height="{{ small_image.height }}">
                  </div>
                  {% if feature.small_caption != blank %}
                    <figcaption class="polaroid__caption">{{ feature.small_caption }}</figcaption>
                  {% endif %}
                </figure>
              {% endif %}

              {% if tertiary_image != blank %}
                <figure class="polaroid polaroid--tertiary">
                  <div class="polaroid__frame">
                    <img src="{{ tertiary_image | image_url: width: 900 }}" alt="{{ tertiary_image.alt | escape }}" loading="lazy" width="{{ tertiary_image.width }}" height="{{ tertiary_image.height }}">
                  </div>
                  {% if feature.tertiary_caption != blank %}
                    <figcaption class="polaroid__caption">{{ feature.tertiary_caption }}</figcaption>
                  {% endif %}
                </figure>
              {% endif %}

              <div class="editorial-feature__copy">
                {% assign tag = feature.tag | default: feature.category %}
                {% if tag != blank %}<p class="intro-text">{{ tag }}</p>{% endif %}
                {% assign title_tag = block.settings.heading_tag | default: 'h2' %}
                <{{ title_tag }} class="feature-title">{{ feature.title | default: feature.name | escape }}</{{ title_tag }}>
                {% if feature.price_copy != blank %}
                  <p class="feature-price">{{ feature.price_copy }}</p>
                {% endif %}
              </div>

              {% if feature.description != blank %}
                <div class="editorial-feature__description rte">{{ feature.description }}</div>
              {% endif %}
            </div>
          </div>
      {% endcase %}
    {% endfor %}
  </div>
</section>

{% schema %}
{
  "name": "Detailed product builder",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading" },
    { "type": "richtext", "id": "content", "label": "Intro content" }
  ],
  "blocks": [
    { "type": "text", "name": "Text", "settings": [ { "type": "text", "id": "text", "label": "Text" } ] },
    { "type": "subheading", "name": "Subheading", "settings": [ { "type": "text", "id": "subheading", "label": "Subheading" } ] },
    { "type": "spacer", "name": "Spacer", "settings": [ { "type": "range", "id": "height", "label": "Height", "min": 8, "max": 200, "step": 4, "default": 40 } ] },
    { "type": "richtext", "name": "Rich text", "settings": [ { "type": "richtext", "id": "richtext", "label": "Content" } ] },
    { "type": "image", "name": "Image", "settings": [
      { "type": "image_picker", "id": "image", "label": "Image" },
      { "type": "text", "id": "alt", "label": "Alt text" },
      { "type": "text", "id": "caption", "label": "Caption" },
      { "type": "range", "id": "max_width", "label": "Max width (px)", "min": 100, "max": 1600, "step": 20, "default": 800 },
      { "type": "select", "id": "alignment", "label": "Alignment", "default": "center", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ] }
    ] },
    { "type": "button", "name": "Button", "settings": [
      { "type": "url", "id": "link", "label": "Link" },
      { "type": "text", "id": "label", "label": "Label" },
      { "type": "select", "id": "alignment", "label": "Alignment", "default": "center", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ] }
    ] },
    { "type": "divider", "name": "Divider", "settings": [] },
    { "type": "liquid", "name": "Custom liquid", "settings": [ { "type": "liquid", "id": "custom_liquid", "label": "Liquid" } ] },
    { "type": "product", "name": "Product", "settings": [ { "type": "product", "id": "product", "label": "Product" } ] },
    { "type": "collection", "name": "Collection", "settings": [
      { "type": "collection", "id": "collection", "label": "Collection" },
      { "type": "range", "id": "limit", "label": "Product limit", "min": 2, "max": 12, "step": 1, "default": 4 },
      { "type": "range", "id": "columns", "label": "Columns", "min": 2, "max": 4, "step": 1, "default": 4 }
    ] },
    { "type": "video", "name": "Video (YouTube/Vimeo)", "settings": [
      { "type": "text", "id": "video_url", "label": "Video URL" },
      { "type": "select", "id": "alignment", "label": "Alignment", "default": "center", "options": [ { "value": "left", "label": "Left" }, { "value": "center", "label": "Center" }, { "value": "right", "label": "Right" } ] }
    ] },
    { "type": "editorial_product_feature", "name": "Editorial product feature", "limit": 1, "settings": [
      { "type": "metaobject", "id": "metaobject", "label": "Editorial product metaobject", "metaobject_type": "editorial_product_feature" },
      { "type": "text", "id": "hero_caption_override", "label": "Hero caption override" },
      { "type": "select", "id": "heading_tag", "label": "Heading tag", "default": "h2", "options": [ { "value": "h1", "label": "H1" }, { "value": "h2", "label": "H2" }, { "value": "h3", "label": "H3" } ] },
      { "type": "color", "id": "heading_colour", "label": "Heading colour", "default": "#000000" },
      { "type": "color", "id": "band_colour", "label": "Band colour", "default": "#ffd200" }
    ] }
  ],
  "presets": [ { "name": "Detailed product builder" } ]
}
{% endschema %}

{% stylesheet %}
.section--detailed-product-builder { padding: 2rem 0; }
.builder-divider { margin: 2rem 0; opacity: .25; }
.builder-button .button { margin-top: .5rem; }
.builder-collection .grid { display:grid; grid-template-columns:repeat(var(--grid-cols),1fr); gap:1.5rem; }
.builder-video .video-wrapper { position:relative; padding-bottom:56.25%; height:0; }
.builder-video iframe { position:absolute; inset:0; width:100%; height:100%; }
.builder-image { margin:2rem auto; }
.builder-image__caption { font-size:.85rem; opacity:.7; margin-top:.25rem; text-align:center; }
/* Editorial feature layout */
.editorial-feature { position:relative; margin:4rem 0; }
.editorial-feature__stage { position:relative; background:#000; overflow:hidden; min-height:500px; }
.editorial-feature__band { position:absolute; top:60px; left:0; width:100%; height:260px; background:var(--band-col,#ffd200); }
.polaroid { position:absolute; display:flex; flex-direction:column; background:#f2f2f2; box-shadow:0 10px 22px -4px rgba(0,0,0,.35); transform:rotate(-2deg); }
.polaroid__frame { padding:.85rem; }
.polaroid__frame img { width:100%; height:auto; display:block; }
.polaroid__caption { font-family:var(--font-heading-family); font-size:14px; padding:0 .8rem .75rem; line-height:1.1; text-align:center; transform:rotate(1deg); }
.polaroid--hero { top:20px; left:8vw; width:270px; transform:rotate(-3deg); }
.polaroid--small { top:120px; right:8vw; width:200px; transform:rotate(2deg); }
.polaroid--tertiary { bottom:40px; right:6vw; width:360px; transform:rotate(-1deg); }
.editorial-feature__copy { position:absolute; top:50%; transform:translateY(-50%); left:50%; width:min(42ch,40%); color:#000; font-family:var(--font-body-family); }
.editorial-feature__copy .intro-text { font-size:14px; line-height:1.5; margin:0; text-transform:uppercase; letter-spacing:0.5px; }
.editorial-feature .feature-title { font-family:var(--font-heading-family); font-size:28px; font-weight:700; color:var(--title-col,#000); margin:1rem 0 .3rem; line-height:1.12; }
.editorial-feature .feature-price { font-size:12px; margin:0; font-weight:600; }
.editorial-feature__description { position:absolute; bottom:40px; left:8vw; max-width:380px; color:#fff; font-size:13px; line-height:1.55; }
@media (max-width:1100px){
  .editorial-feature__stage { padding:3rem 1.25rem 4rem; min-height:auto; }
  .editorial-feature__band { position:static; height:auto; min-height:260px; margin:0 -1.25rem; }
  .polaroid, .polaroid--hero, .polaroid--small, .polaroid--tertiary { position:static; width:100%; max-width:340px; margin:2rem auto 0; transform:none; }
  .editorial-feature__copy { position:static; transform:none; left:auto; width:100%; margin:2rem auto 0; text-align:center; }
  .editorial-feature__description { position:static; max-width:60ch; margin:2.5rem auto 0; color:#fff; text-align:center; }
}
{% endstylesheet %}{%- comment -%}
{%- endcomment -%}
